<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ê´€ë¦¬ì ëª¨ë“œ - NICU wanted off</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-admin   { @apply px-4 py-2 bg-indigo-600 text-white rounded-full shadow hover:bg-indigo-700 transition; }
    .btn-nav     { @apply px-4 py-2 bg-indigo-500 text-white rounded-full shadow hover:bg-indigo-600 transition; }
    .btn-save    { @apply px-4 py-2 bg-green-500 text-white rounded-full shadow hover:bg-green-600 transition animate-pulse; }
    .cell-booked { @apply bg-red-100; }
    .cell-open   { @apply bg-green-100 cursor-pointer hover:bg-green-200; }
    .admin-added { @apply font-bold bg-yellow-200; }
    .disabled    { @apply opacity-50 cursor-not-allowed; }
    .img-btn     { @apply w-6 h-6 cursor-pointer; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ</h1>
  <button id="logoutAdmin" class="btn-admin mb-4">ë¡œê·¸ì•„ì›ƒ</button>

  <!-- ì›” ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="flex items-center justify-center mb-4 space-x-4">
    <button id="prevMonth" class="btn-nav">â€¹ ì´ì „ì›”</button>
    <span id="monthLabel" class="text-xl font-semibold"></span>
    <button id="nextMonth" class="btn-nav">ë‹¤ìŒì›” â€º</button>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- ë‹¬ë ¥ ì˜ì—­ -->
    <div class="lg:col-span-2 overflow-x-auto">
      <table class="w-full bg-white rounded-lg shadow text-center">
        <thead class="bg-indigo-100">
          <tr>
            <th class="p-2">ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
          </tr>
        </thead>
        <tbody id="adminCalendar" class="divide-y"></tbody>
      </table>
    </div>

    <!-- ìš°ì¸¡: ì˜ˆì•½ì ëª©ë¡ â†’ NICU ëª©ë¡ â†’ ì‹ ì²­ê¸°ê°„ ì„¤ì • -->
    <div class="space-y-6">
      <!-- 1. ì˜ˆì•½ì ëª©ë¡ -->
      <div id="details" class="bg-white p-4 rounded-lg shadow">
        <h2 id="detailDate" class="text-xl font-semibold mb-2">ì˜ˆì•½ì ëª©ë¡</h2>
        <ul id="detailList" class="space-y-2"></ul>
      </div>

      <!-- 2. NICU ëª©ë¡ -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-2">NICU</h2>
        <ul id="whitelist" class="grid grid-cols-3 gap-2"></ul>
      </div>

      <!-- 3. ì‹ ì²­ ê¸°ê°„ ì„¤ì • -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-2">ì‹ ì²­ ê¸°ê°„ ì„¤ì •</h2>
        <form id="periodForm" class="space-y-3">
          <div class="flex items-center space-x-2">
            <label class="w-20">ëŒ€ìƒ ì›”</label>
            <input type="month" id="periodMonth" class="border rounded px-2 py-1 flex-1"/>
          </div>
          <div class="flex items-center space-x-2">
            <label class="w-20">ì‹œì‘</label>
            <input type="datetime-local" id="periodStart" class="border rounded px-2 py-1 flex-1"/>
          </div>
          <div class="flex items-center space-x-2">
            <label class="w-20">ì¢…ë£Œ</label>
            <input type="datetime-local" id="periodEnd" class="border rounded px-2 py-1 flex-1"/>
          </div>
          <div class="flex justify-center">
            <button type="submit" class="btn-save">ì €ì¥</button>
          </div>
        </form>
        <ul id="periodList" class="mt-4 space-y-2 text-sm text-gray-700"></ul>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // Helpers
    const getData       = () => JSON.parse(localStorage.getItem('app_data')      || '{}');
    const saveData      = d => localStorage.setItem('app_data',      JSON.stringify(d));
    const getAdminAdds  = () => JSON.parse(localStorage.getItem('app_adminAdds')|| '{}');
    const saveAdminAdds = d => localStorage.setItem('app_adminAdds', JSON.stringify(d));
    const getPeriods    = () => JSON.parse(localStorage.getItem('app_periods')  || '{}');
    const savePeriods   = p => localStorage.setItem('app_periods', JSON.stringify(p));

     // Whitelist names restored
      const allowedNames = [
        "ì²œì§€ì›","ì´ì‹œí–¥","ì´ìŠ¬ë¹„","ì´ì˜ìˆ™","êµ¬ìŠ¬ë¹„","ê¹€ì •í˜„","ê³ ì˜í™”","ì˜¤í˜„ì§€","ì´ì§€ìˆ˜",
        "ì „í˜œì„ ","ì¡°í™”ì—°","ìœ¤ìˆ˜ì§„","ìµœì›ì •","ê¶Œë‚˜ê²½","ê¹€ì£¼í˜„","ê¹€ìœ ì§„","ë°°ì¸ê²½","ì´í˜œìˆ˜",
        "ì„œì˜ì„œ","í™ìˆ˜ì•„","ë°•ì£¼í˜„","ì—„ë‚˜í˜œ","ì´ìˆ˜ì§€","ì •í˜œì•„","ì´ì‹œì€","ë°±ì§€ì—°","í—ˆìë ¹",
        "ê¹€ìˆ˜ë¯¼","ì´ë‹¤ê²½","ì‹ ì˜¥ë¹„","ë°•ì¸í¬","ì‹ ì£¼ì˜","ìµœì€ë°©","ê¸¸ìš©ìˆœ","í•œì€ì§„","ì‹¬ë‚˜ì˜",
        "ë°•í¬ì—°","ì›ìœ ë¯¸","ì¸íœ˜"
      ];
    
    // DOM
    const adminCal   = document.getElementById('adminCalendar');
    const detailDate = document.getElementById('detailDate');
    const detailList = document.getElementById('detailList');
    const whitelist  = document.getElementById('whitelist');
    const logoutBtn  = document.getElementById('logoutAdmin');
    const prevMonth  = document.getElementById('prevMonth');
    const nextMonth  = document.getElementById('nextMonth');
    const monthLabel = document.getElementById('monthLabel');
    const periodForm = document.getElementById('periodForm');
    const periodList = document.getElementById('periodList');
    const monthInput = document.getElementById('periodMonth');
    const startInput = document.getElementById('periodStart');
    const endInput   = document.getElementById('periodEnd');

    let cur = new Date(), editing = null;

    // Logout & nav
    logoutBtn.onclick = () => {
      localStorage.removeItem('app_current');
      location.href = 'index.html';
    };
    prevMonth.onclick = () => { cur.setMonth(cur.getMonth()-1); renderCalendar(); };
    nextMonth.onclick = () => { cur.setMonth(cur.getMonth()+1); renderCalendar(); };

    // Render periods list
    function renderPeriods() {
      const p = getPeriods();
      periodList.innerHTML = '';
      Object.entries(p).sort().forEach(([ym,{start,end}]) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center';
        li.innerHTML = `
          <span>${ym}: ${new Date(start).toLocaleString()} ~ ${new Date(end).toLocaleString()}</span>
          <div class="flex space-x-2">
            <img src="https://img.icons8.com/ios-glyphs/30/000000/edit--v1.png"
                 class="img-btn" data-action="edit" data-ym="${ym}" />
            <img src="https://img.icons8.com/ios-glyphs/30/000000/multiply.png"
                 class="img-btn" data-action="delete" data-ym="${ym}" />
          </div>`;
        periodList.appendChild(li);
      });
    }
    renderPeriods();

    // Handle save/edit
    periodForm.onsubmit = e => {
      e.preventDefault();
      const ym = monthInput.value, s = startInput.value, en = endInput.value;
      if(!ym||!s||!en){ alert('ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if(s>=en){ alert('ì‹œì‘ì¼ì‹œëŠ” ì¢…ë£Œì¼ì‹œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
      const periods = getPeriods();
      if (!editing && periods[ym]) {
        alert('ì´ë¯¸ ì„¤ì •ëœ ì›”ì…ë‹ˆë‹¤.');
        return;
      }
      delete periods[editing]; // if editing, remove old key
      periods[ym] = { start:new Date(s).toISOString(), end:new Date(en).toISOString() };
      savePeriods(periods);
      periodForm.reset();
      editing = null;
      renderPeriods();
    };

    // Edit/Delete click
    periodList.addEventListener('click', e => {
      const btn = e.target.closest('.img-btn');
      if (!btn) return;
      const action = btn.dataset.action, ym = btn.dataset.ym;
      const periods = getPeriods();
      if (action==='delete') {
        if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          delete periods[ym];
          savePeriods(periods);
          renderPeriods();
        }
      } else if (action==='edit') {
        editing = ym;
        const { start, end } = periods[ym];
        monthInput.value = ym;
        startInput.value = start.slice(0,16);
        endInput.value   = end.slice(0,16);
      }
    });

    // Render calendar immediately on load
    renderCalendar();

    function renderCalendar(){
      adminCal.innerHTML = '';
      const year = cur.getFullYear(), mo = cur.getMonth();
      monthLabel.textContent = `${year}ë…„ ${mo+1}ì›”`;
      const first = new Date(year, mo, 1).getDay();
      const days  = new Date(year, mo+1, 0).getDate();
      let row = document.createElement('tr');
      for(let i=0;i<first;i++) row.appendChild(document.createElement('td'));

      const data = getData(), adds = getAdminAdds();
      for(let d=1; d<=days; d++){
        if((first+d-1)%7===0 && d!==1){
          adminCal.appendChild(row);
          row = document.createElement('tr');
        }
        const ds = `${year}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const users = data[ds]||[], admins = adds[ds]||[];
        const names = users.concat(admins.map(n=>'ğŸ‘‘ '+n));
        const td = document.createElement('td');
        td.className = names.length?'cell-booked p-2':'cell-open p-2';
        td.innerHTML = `<div class="font-semibold mb-1">${d}</div>`
                     + names.map(n=>`<div class="text-sm">${n}</div>`).join('');
        td.onclick = ()=> showDetails(ds);
        row.appendChild(td);
      }
      while(row.children.length<7) row.appendChild(document.createElement('td'));
      adminCal.appendChild(row);
    }

    // Details & NICU
    function showDetails(date){
      detailDate.textContent = `ì˜ˆì•½ì ëª©ë¡ â€” ${date}`;
      detailList.innerHTML = '';
      const data = getData(), adds = getAdminAdds();
      const users = data[date]||[], admins=adds[date]||[];

      users.forEach((n,i)=>{
        const li = document.createElement('li');
        li.className='flex justify-between items-center';
        li.innerHTML=`<span>${i+1}. ${n}</span><button class="text-red-500">ì·¨ì†Œ</button>`;
        li.querySelector('button').onclick=()=>{
          if(confirm('ì·¨ì†Œ?')){
            const rem = users.filter(x=>x!==n);
            if(rem.length) data[date]=rem; else delete data[date];
            saveData(data); renderCalendar(); showDetails(date);
          }
        };
        detailList.appendChild(li);
      });

      admins.forEach((n,i)=>{
        const li = document.createElement('li');
        li.className='flex justify-between items-center admin-added';
        li.innerHTML=`<span>${users.length+i+1}. ğŸ‘‘ ${n}</span><button class="text-red-500">ì·¨ì†Œ</button>`;
        li.querySelector('button').onclick=()=>{
          if(confirm('ì·¨ì†Œ?')){
            const rem = admins.filter(x=>x!==n);
            if(rem.length) adds[date]=rem; else delete adds[date];
            saveAdminAdds(adds); renderCalendar(); showDetails(date);
          }
        };
        detailList.appendChild(li);
      });
 
      if(!users.length && !admins.length) detailList.textContent='ì˜ˆì•½ìê°€ ì—†ìŠµë‹ˆë‹¤.';

      whitelist.innerHTML='';
      allowedNames.slice().sort((a,b)=>a.localeCompare(b,'ko')).forEach(n=>{
        const li=document.createElement('li');
        li.className='flex justify-center';
        const btn=document.createElement('button');
        btn.textContent = n; btn.className='btn-admin w-full';
        const taken = (data[date]||[]).concat(adds[date]||[]).includes(n);
        if(taken || (data[date]||[]).length+(adds[date]||[]).length>=3){
          btn.disabled=true; btn.classList.add('disabled');
        } else {
          btn.onclick=()=>{ adds[date]=[...(adds[date]||[]),n]; saveAdminAdds(adds); renderCalendar(); showDetails(date); };
        }
        li.appendChild(btn); whitelist.appendChild(li);
      });
    }
  });
  </script>
</body>
</html>
