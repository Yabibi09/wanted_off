<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>â¤ï¸ NICU wanted off â¤ï¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-4 gap-4">
    <!-- ì¢Œì¸¡: ì¸ì¦ & ë‹¬ë ¥ -->
    <div class="lg:col-span-3 space-y-6">
      <h1 class="text-3xl font-bold text-center">â¤ï¸ NICU wanted off â¤ï¸</h1>
      <!-- ì¸ì¦ -->
      <div id="auth" class="space-y-4">
        <div class="flex justify-center gap-4">
          <button id="showLogin" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow">ë¡œê·¸ì¸</button>
          <button id="showRegister" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow">íšŒì›ê°€ì…</button>
        </div>
        <form id="formLogin" class="space-y-3 hidden bg-white p-4 rounded-lg shadow">
          <h2 class="text-xl font-semibold">ë¡œê·¸ì¸</h2>
          <input id="loginName" placeholder="ì´ë¦„" required class="w-full px-3 py-2 border rounded-lg"/>
          <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required class="w-full px-3 py-2 border rounded-lg"/>
          <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg">ë¡œê·¸ì¸</button>
        </form>
        <form id="formRegister" class="space-y-3 hidden bg-white p-4 rounded-lg shadow">
          <h2 class="text-xl font-semibold">íšŒì›ê°€ì…</h2>
          <input id="regName" placeholder="ì´ë¦„(Whitelist)" required class="w-full px-3 py-2 border rounded-lg"/>
          <input id="regPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required class="w-full px-3 py-2 border rounded-lg"/>
          <button type="submit" class="w-full py-2 bg-green-600 text-white rounded-lg">íšŒì›ê°€ì…</button>
        </form>
      </div>
      <!-- ë‹¬ë ¥ & ì‹ ì²­ -->
      <div id="app" class="hidden space-y-4">
        <div class="flex justify-between items-center">
          <span id="welcome" class="text-lg font-medium"></span>
          <button id="logout" class="px-3 py-1 bg-red-500 text-white rounded-lg shadow">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <!-- íƒ€ì´ë¨¸ í‘œì‹œ -->
        <div class="text-right text-sm text-gray-600">
          ë‚¨ì€ ì‹œê°„: <span id="timer">--:--</span>
        </div>
        <div class="flex justify-between items-center">
          <button id="prev" class="px-3 py-1 bg-gray-300 rounded-lg">â€¹ ì´ì „</button>
          <span id="monthLabel" class="text-lg font-semibold"></span>
          <button id="next" class="px-3 py-1 bg-gray-300 rounded-lg">ë‹¤ìŒ â€º</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow">
            <thead class="bg-blue-100">
              <tr><th class="py-2">ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr>
            </thead>
            <tbody id="calendar" class="divide-y"></tbody>
          </table>
        </div>
        <div class="flex items-center space-x-4">
          <span>ì„ íƒëœ ë‚ ì§œ (<span id="selCount">0</span>/3): <strong id="selectedDates">ì—†ìŒ</strong></span>
          <button id="applyBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50" disabled>ì‹ ì²­í•˜ê¸°</button>
        </div>
      </div>
    </div>
    <!-- ìš°ì¸¡: ì‹ ì²­ë‚´ì—­ -->
    <div id="history" class="space-y-4 hidden">
      <h2 class="text-xl font-semibold">ì‹ ì²­ë‚´ì—­</h2>
      <ul id="myList" class="bg-white p-4 rounded-lg shadow space-y-2"></ul>
    </div>
  </div>
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const INACTIVITY_LIMIT = 10*60*1000;
    const allowedNames = ["admin","ì²œì§€ì›","ì´ì‹œí–¥","ì´ìŠ¬ë¹„","ì´ì˜ìˆ™","êµ¬ìŠ¬ë¹„","ê¹€ì •í˜„","ê³ ì˜í™”","ì˜¤í˜„ì§€","ì´ì§€ìˆ˜","ì „í˜œì„ ","ì¡°í™”ì—°","ìœ¤ìˆ˜ì§„","ìµœì›ì •","ê¶Œë‚˜ê²½","ê¹€ì£¼í˜„","ê¹€ìœ ì§„","ë°°ì¸ê²½","ì´í˜œìˆ˜","ì„œì˜ì„œ","í™ìˆ˜ì•„","ë°•ì£¼í˜„","ì—„ë‚˜í˜œ","ì´ìˆ˜ì§€","ì •í˜œì•„","ì´ì‹œì€","ë°±ì§€ì—°","í—ˆìë ¹","ê¹€ìˆ˜ë¯¼","ì´ë‹¤ê²½","ì‹ ì˜¥ë¹„","ë°•ì¸í¬","ì‹ ì£¼ì˜","ìµœì€ë°©","ê¸¸ìš©ìˆœ","í•œì€ì§„","ì‹¬ë‚˜ì˜","ë°•í¬ì—°","ì›ìœ ë¯¸","ì¸íœ˜"];

    // Storage helpers
    const getUsers       = () => JSON.parse(localStorage.getItem('app_users')   || '[]');
    const saveUsers      = u => localStorage.setItem('app_users', JSON.stringify(u));
    const getData        = () => JSON.parse(localStorage.getItem('app_data')    || '{}');
    const saveData       = d => localStorage.setItem('app_data', JSON.stringify(d));
    const getAdminAdds   = () => JSON.parse(localStorage.getItem('app_adminAdds')|| '{}');
    const saveAdminAdds  = d => localStorage.setItem('app_adminAdds', JSON.stringify(d));
    const updateActivity = () => localStorage.setItem('lastActivity', Date.now());

    // DOM refs
    const authDiv      = document.getElementById('auth'),
          formLogin    = document.getElementById('formLogin'),
          formRegister = document.getElementById('formRegister'),
          appDiv       = document.getElementById('app'),
          historyDiv   = document.getElementById('history'),
          welcome      = document.getElementById('welcome'),
          timerEl      = document.getElementById('timer'),
          calBody      = document.getElementById('calendar'),
          monthLabel   = document.getElementById('monthLabel'),
          selDatesEl   = document.getElementById('selectedDates'),
          selCountEl   = document.getElementById('selCount'),
          applyBtn     = document.getElementById('applyBtn'),
          myList       = document.getElementById('myList');

    let currentUser = localStorage.getItem('app_current')||'';
    let cur=new Date(), selected=[]; let timerInterval;

    function startTimer(){
      function upd(){
        const last=+localStorage.getItem('lastActivity')||0;
        const diff=INACTIVITY_LIMIT-(Date.now()-last);
        if(diff<=0){alert('ìë™ ë¡œê·¸ì•„ì›ƒ ë©ë‹ˆë‹¤.');logout();return;}
        const m=String(Math.floor(diff/60000)).padStart(2,'0'),
              s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
        timerEl.textContent=`${m}:${s}`;
      }
      upd();return setInterval(upd,1000);
    }
    function showAuth(){authDiv.classList.remove('hidden');appDiv.classList.add('hidden');historyDiv.classList.add('hidden');clearInterval(timerInterval);}
    function showApp(){if(!currentUser)return showAuth();authDiv.classList.add('hidden');appDiv.classList.remove('hidden');historyDiv.classList.remove('hidden');welcome.textContent=`${currentUser} ì„ ìƒë‹˜ ğŸ¥`;updateActivity();timerInterval=startTimer();renderCalendar();renderMyList();updateSelectionUI();}

    function login(name){if(name==='admin')return window.location.href='admin.html';currentUser=name;localStorage.setItem('app_current',name);showApp();}
    function logout(){localStorage.removeItem('app_current');currentUser='';showAuth();}

    formRegister.onsubmit=e=>{e.preventDefault();const n=document.getElementById('regName').value.trim(),p=document.getElementById('regPw').value;if(!allowedNames.includes(n)){alert('í—ˆìš©ëœ ì´ë¦„ì´ ì•„ë‹™ë‹ˆë‹¤.');return;}let u=getUsers();if(u.find(x=>x.name===n)){alert('ì´ë¯¸ ì¡´ì¬');return;}u.push({name:n,pw:p});saveUsers(u);alert('ê°€ì… ì™„ë£Œ');formRegister.classList.add('hidden');formLogin.classList.remove('hidden');};
    formLogin.onsubmit=e=>{e.preventDefault();const n=document.getElementById('loginName').value.trim(),p=document.getElementById('loginPw').value;const u=getUsers().find(x=>x.name===n&&x.pw===p);if(!u){alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');return;}login(n);};
    document.getElementById('showLogin').onclick=()=>{formLogin.classList.remove('hidden');formRegister.classList.add('hidden');showAuth();};
    document.getElementById('showRegister').onclick=()=>{formRegister.classList.remove('hidden');formLogin.classList.add('hidden');showAuth();};
    document.getElementById('logout').onclick=logout;
    document.getElementById('prev').onclick=()=>{cur.setMonth(cur.getMonth()-1);renderCalendar();};
    document.getElementById('next').onclick=()=>{cur.setMonth(cur.getMonth()+1);renderCalendar();};
    applyBtn.onclick=()=>applySelected();

    // í•œ ë‹¬ ëˆ„ì  ì‹ ì²­ ì¼ìˆ˜ ê³„ì‚° (ê´€ë¦¬ì ì˜ˆì•½ í¬í•¨)
    function countThisMonth(user,data,yy,mm){
      const adminAdds=getAdminAdds();
      return Object.entries(data).filter(([date,arr])=>{
        if(!date.startsWith(`${yy}-${String(mm+1).padStart(2,'0')}`))return false;
        const admins=adminAdds[date]||[];
        return arr.includes(user)||admins.includes(user);
      }).length;
    }

    function applySelected(){
      const data=getData(),admins=getAdminAdds(),y=cur.getFullYear(),m=cur.getMonth(),exist=countThisMonth(currentUser,data,y,m);
      if(exist+selected.length>8){alert(`í•œ ë‹¬ ìµœëŒ€ 8ì¼(í˜„ì¬ ${exist}ì¼) ì´ˆê³¼`);return;}
      selected.forEach(ds=>{
        const arr=data[ds]||[], adm=admins[ds]||[];
        if(arr.length+adm.length<3&&!arr.includes(currentUser)&&!adm.includes(currentUser))arr.push(currentUser);
        data[ds]=arr;
      });
      saveData(data);selected=[];renderCalendar();renderMyList();updateSelectionUI();
    }

    function renderCalendar(){
      calBody.innerHTML='';monthLabel.textContent=`${cur.getFullYear()}ë…„ ${cur.getMonth()+1}ì›”`;
      const first=new Date(cur.getFullYear(),cur.getMonth(),1).getDay(),days=new Date(cur.getFullYear(),cur.getMonth()+1,0).getDate();
      let row=document.createElement('tr');
      for(let i=0;i<first;i++)row.appendChild(makeCell(''));
      const data=getData(),admins=getAdminAdds();
      for(let d=1;d<=days;d++){
        if((first+d-1)%7===0&&d!==1){calBody.appendChild(row);row=document.createElement('tr');}
        const ds=`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const arr=data[ds]||[], adm=admins[ds]||[];
        row.appendChild(makeCell(d,false,ds,arr,adm));
      }
      while(row.children.length<7)row.appendChild(makeCell(''));
      calBody.appendChild(row);updateSelectionUI();
    }

    function makeCell(day,disabled=false,ds='',arr=[],adm=[]){
      const merged=arr.concat(adm);
      const td=document.createElement('td');
      td.className=disabled?'disabled p-2':'p-2';
      if(!disabled&&day){
        if(merged.includes(currentUser)){
          td.classList.add('bg-red-100');
          td.onclick=()=>alert('ì´ë¯¸ ì‹ ì²­í•œ ë‚ ì§œì…ë‹ˆë‹¤.');
        } else if(merged.length>=3){
          td.classList.add('bg-gray-300','text-gray-500');
          td.onclick=()=>alert('ë§ˆê°ëœ ë‚ ì§œì…ë‹ˆë‹¤.');
        } else {
          td.classList.add('cursor-pointer','hover:bg-blue-50');
          td.onclick=()=>toggleSelect(ds);
        }
      }
      td.innerHTML=disabled?'':`<div>${day}</div><div class="count text-sm text-gray-600">${merged.length}/3</div>`;
      return td;
    }

    function isConsecutive(d){const a=Array.from(new Set(d.map(x=>new Date(x).setHours(0,0,0,0)))).sort((a,b)=>a-b);let r=1;for(let i=1;i<a.length;i++){if(a[i]-a[i-1]===86400000){r++;if(r>3)return false;}else r=1;}return true;}

    function toggleSelect(ds){
      const i=selected.indexOf(ds),data=getData(),admins=getAdminAdds();
      const existDates=Object.entries(data).filter(([date,arr])=>{
        if(!date.startsWith(`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`))return false;
        const adm=admins[date]||[];
        return arr.includes(currentUser)||adm.includes(currentUser);
      }).map(([d])=>d);
      let temp=i>=0?selected.filter(x=>x!==ds):[...selected,ds];
      if(!isConsecutive(existDates.concat(temp))){alert('ì—°ì† ì‹ ì²­ì€ ìµœëŒ€ 3ì¼ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');return;}
      if(i>=0)selected.splice(i,1);else{if(selected.length>=3){alert('í•œ ë²ˆì— ìµœëŒ€ 3ì¼ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');return;}selected.push(ds);}
      updateSelectionUI();
    }

    function updateSelectionUI(){document.querySelectorAll('#calendar td').forEach(td=>td.classList.remove('bg-blue-200'));selected.forEach(ds=>{document.querySelectorAll('#calendar td').forEach(td=>{if(td.innerText.startsWith(String(Number(ds.slice(-2)))))td.classList.add('bg-blue-200');});});selDatesEl.textContent=selected.join(', ')||'ì—†ìŒ';selCountEl.textContent=selected.length;applyBtn.disabled=selected.length===0;}

    function renderMyList(){
      myList.innerHTML='';
      const data=getData(),admins=getAdminAdds();
      // combine dates where currentUser is in data or admins
      const dates = new Set([
        ...Object.keys(data).filter(d=>data[d].includes(currentUser)),
        ...Object.keys(admins).filter(d=>admins[d].includes(currentUser))
      ]);
      Array.from(dates).sort().forEach(date=>{
        const isAdmin = (admins[date]||[]).includes(currentUser);
        const li = document.createElement('li');
        li.className='flex justify-between items-center';
        li.innerHTML = `<span>${date} ${isAdmin?'<span class="ml-2">ğŸ‘‘</span>':''}</span><button class="text-red-500">X</button>`;
        li.querySelector('button').onclick=()=>{
          if(!confirm('ì·¨ì†Œí• ê¹Œìš”?')) return;
          if(isAdmin) {
            admins[date] = admins[date].filter(n=>n!==currentUser);
            if(!admins[date].length) delete admins[date];
            saveAdminAdds(admins);
          } else {
            data[date] = data[date].filter(n=>n!==currentUser);
            if(!data[date].length) delete data[date];
            saveData(data);
          }
          renderCalendar(); renderMyList();
        };
        myList.appendChild(li);
      });
    }

    ['click','keydown','mousemove'].forEach(evt=>document.addEventListener(evt,updateActivity));
    if(currentUser){updateActivity();showApp();}else showAuth();
  });
  </script>
</body>
</html>
