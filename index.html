<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>❤️ NICU wanted off ❤️</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-4 gap-4">
    <!-- 좌측: 인증 & 달력 -->
    <div class="lg:col-span-3 space-y-6">
      <h1 class="text-3xl font-bold text-center">❤️ NICU wanted off ❤️</h1>
      <!-- 인증 -->
      <div id="auth" class="space-y-4">
        <div class="flex justify-center gap-4">
          <button id="showLogin" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow">로그인</button>
          <button id="showRegister" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow">회원가입</button>
        </div>
        <form id="formLogin" class="space-y-3 hidden bg-white p-4 rounded-lg shadow">
          <h2 class="text-xl font-semibold">로그인</h2>
          <input id="loginName" placeholder="이름" required class="w-full px-3 py-2 border rounded-lg"/>
          <input id="loginPw" type="password" placeholder="비밀번호" required class="w-full px-3 py-2 border rounded-lg"/>
          <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg">로그인</button>
        </form>
        <form id="formRegister" class="space-y-3 hidden bg-white p-4 rounded-lg shadow">
          <h2 class="text-xl font-semibold">회원가입</h2>
          <input id="regName" placeholder="이름(Whitelist)" required class="w-full px-3 py-2 border rounded-lg"/>
          <input id="regPw" type="password" placeholder="비밀번호" required class="w-full px-3 py-2 border rounded-lg"/>
          <button type="submit" class="w-full py-2 bg-green-600 text-white rounded-lg">회원가입</button>
        </form>
      </div>
      <!-- 달력 & 신청 -->
      <div id="app" class="hidden space-y-4">
        <div class="flex justify-between items-center">
          <span id="welcome" class="text-lg font-medium"></span>
          <button id="logout" class="px-3 py-1 bg-red-500 text-white rounded-lg shadow">로그아웃</button>
        </div>
        <!-- 타이머 표시 -->
        <div class="text-right text-sm text-gray-600">
          남은 시간: <span id="timer">--:--</span>
        </div>
        <div class="flex justify-between items-center">
          <button id="prev" class="px-3 py-1 bg-gray-300 rounded-lg">‹ 이전</button>
          <span id="monthLabel" class="text-lg font-semibold"></span>
          <button id="next" class="px-3 py-1 bg-gray-300 rounded-lg">다음 ›</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow">
            <thead class="bg-blue-100">
              <tr><th class="py-2">일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr>
            </thead>
            <tbody id="calendar" class="divide-y"></tbody>
          </table>
        </div>
        <div class="flex items-center space-x-4">
          <span>선택된 날짜 (<span id="selCount">0</span>/3): <strong id="selectedDates">없음</strong></span>
          <button id="applyBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50" disabled>신청하기</button>
        </div>
      </div>
    </div>
    <!-- 우측: 신청내역 -->
    <div class="space-y-4 hidden" id="history">
      <h2 class="text-xl font-semibold">신청내역</h2>
      <ul id="myList" class="bg-white p-4 rounded-lg shadow space-y-2"></ul>
    </div>
  </div>
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const INACTIVITY_LIMIT = 10*60*1000;
    const allowedNames = ["Alice","Bob","Charlie","Delta","Echo"];
    let currentUser=localStorage.getItem('app_current')||'', cur=new Date(), selected=[];
    let timerInterval;

    const authDiv=document.getElementById('auth'), formLogin=document.getElementById('formLogin'), formRegister=document.getElementById('formRegister'), appDiv=document.getElementById('app'), historyDiv=document.getElementById('history'), welcome=document.getElementById('welcome'), timerEl=document.getElementById('timer'), calBody=document.getElementById('calendar'), monthLabel=document.getElementById('monthLabel'), selDatesEl=document.getElementById('selectedDates'), selCountEl=document.getElementById('selCount'), applyBtn=document.getElementById('applyBtn'), myList=document.getElementById('myList');

    const getUsers=()=>JSON.parse(localStorage.getItem('app_users')||'[]');
    const saveUsers=u=>localStorage.setItem('app_users',JSON.stringify(u));
    const getData=()=>JSON.parse(localStorage.getItem('app_data')||'{}');
    const saveData=d=>localStorage.setItem('app_data',JSON.stringify(d));
    const updateActivity=()=>localStorage.setItem('lastActivity',Date.now());

    function startTimer(){
      function upd(){
        const last=+localStorage.getItem('lastActivity')||0;
        let diff=INACTIVITY_LIMIT-(Date.now()-last);
        if(diff<=0){alert('자동 로그아웃 됩니다.');logout();return;}        
        const m=String(Math.floor(diff/60000)).padStart(2,'0');
        const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
        timerEl.textContent=`${m}:${s}`;
      }
      upd();return setInterval(upd,1000);
    }

    function showAuth(){authDiv.classList.remove('hidden');appDiv.classList.add('hidden');historyDiv.classList.add('hidden');clearInterval(timerInterval);}    
    function showApp(){if(!currentUser) return showAuth();authDiv.classList.add('hidden');appDiv.classList.remove('hidden');historyDiv.classList.remove('hidden');welcome.textContent=`${currentUser} 선생님 🐥`;updateActivity();timerInterval=startTimer();renderCalendar();renderMyList();updateSelectionUI();}
    function login(name){currentUser=name;localStorage.setItem('app_current',name);showApp();}
    function logout(){localStorage.removeItem('app_current');currentUser='';showAuth();}

    formRegister.onsubmit=e=>{e.preventDefault();const name=document.getElementById('regName').value.trim(),pw=document.getElementById('regPw').value;if(!allowedNames.includes(name)){alert('허용된 이름이 아닙니다.');return;}let u=getUsers();if(u.find(x=>x.name===name)){alert('이미 존재');return;}u.push({name,pw});saveUsers(u);alert('가입 완료');formRegister.classList.add('hidden');formLogin.classList.remove('hidden');};
    formLogin.onsubmit=e=>{e.preventDefault();const name=document.getElementById('loginName').value.trim(),pw=document.getElementById('loginPw').value;const u=getUsers().find(x=>x.name===name&&x.pw===pw);if(!u){alert('로그인 실패');return;}login(name);};
    document.getElementById('showLogin').onclick=()=>{formLogin.classList.remove('hidden');formRegister.classList.add('hidden');showAuth();};
    document.getElementById('showRegister').onclick=()=>{formRegister.classList.remove('hidden');formLogin.classList.add('hidden');showAuth();};
    document.getElementById('logout').onclick=logout;
    document.getElementById('prev').onclick=()=>{cur.setMonth(cur.getMonth()-1);renderCalendar();};
    document.getElementById('next').onclick=()=>{cur.setMonth(cur.getMonth()+1);renderCalendar();};
    applyBtn.onclick=()=>applySelected();

    function countThisMonth(user,data,y,m){return Object.entries(data).filter(([date,arr])=>{if(!arr.includes(user))return false;const [yy,mm]=date.split('-').map(Number);return yy===y&&mm-1===m;}).length;}

    function applySelected(){const data=getData(),y=cur.getFullYear(),m=cur.getMonth(),exist=countThisMonth(currentUser,data,y,m);if(exist+selected.length>8){alert(`한 달 최대 8일(현재 ${exist}일) 초과`);return;}selected.forEach(ds=>{const arr=data[ds]||[];if(arr.length<3&&!arr.includes(currentUser))arr.push(currentUser);data[ds]=arr;});saveData(data);selected=[];renderCalendar();renderMyList();updateSelectionUI();}

    function renderCalendar(){calBody.innerHTML='';monthLabel.textContent=`${cur.getFullYear()}년 ${cur.getMonth()+1}월`;const first=new Date(cur.getFullYear(),cur.getMonth(),1).getDay(),days=new Date(cur.getFullYear(),cur.getMonth()+1,0).getDate();let row=document.createElement('tr');for(let i=0;i<first;i++)row.appendChild(makeCell(''));const data=getData();for(let d=1;d<=days;d++){if((first+d-1)%7===0&&d!==1){calBody.appendChild(row);row=document.createElement('tr');}const ds=`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,arr=data[ds]||[];row.appendChild(makeCell(d,false,ds,arr));}while(row.children.length<7)row.appendChild(makeCell(''));calBody.appendChild(row);updateSelectionUI();}

    function makeCell(day, disabled=false, ds='', arr=[]) {
      const td = document.createElement('td');
      td.className = disabled ? 'disabled p-2' : 'p-2';
      if (!disabled && day) {
        if (arr.includes(currentUser)) {
          td.classList.add('bg-red-100');
          td.onclick = () => alert('이미 신청한 날짜입니다.');
        } else {
          td.classList.add('cursor-pointer','hover:bg-blue-50');
          td.onclick = () => toggleSelect(ds);
        }
      }
      td.innerHTML = disabled ? '' : `<div>${day}</div><div class="count text-sm text-gray-600">${arr.length}/3</div>`;
      return td;
    }

    // 연속 검사: 주어진 날짜 배열에 연속된 날짜가 4일 이상 있는지 체크
    function isConsecutive(dates) {
      const ds = dates.map(d => new Date(d).setHours(0,0,0,0));
      const uniq = Array.from(new Set(ds)).sort((a,b) => a-b);
      let run = 1;
      for (let i = 1; i < uniq.length; i++) {
        if (uniq[i] - uniq[i-1] === 86400000) {
          run++;
          if (run > 3) return false;
        } else {
          run = 1;
        }
      }
      return true;
    }

    // 날짜 선택 토글
    function toggleSelect(ds) {
      const idx = selected.indexOf(ds);
      const data = getData();
      const year = cur.getFullYear(), month = cur.getMonth();
      // 기존 신청된 날짜 (현재 월)
      const existing = Object.keys(data).filter(date => {
        const arr = data[date];
        if (!arr.includes(currentUser)) return false;
        const [y,m] = date.split('-').map(Number);
        return y === year && m-1 === month;
      });
      let temp;
      if (idx >= 0) {
        temp = selected.filter(d => d !== ds);
      } else {
        if (selected.length >= 3) { alert('한 번에 최대 3일 선택 가능합니다.'); return; }
        temp = [...selected, ds];
      }
      // 연속 검사: 기존 + 선택 예정
      const combined = existing.concat(temp);
      if (!isConsecutive(combined)) {
        alert('연속 신청은 최대 3일까지만 가능합니다.');
        return;
      }
      // 최종 선택 적용
      if (idx >= 0) selected.splice(idx,1);
      else selected.push(ds);
      updateSelectionUI();
    }

    // 화면 내역 렌더
    function updateSelectionUI() {
      document.querySelectorAll('#calendar td').forEach(td => td.classList.remove('bg-blue-200'));
      selected.forEach(ds => {
        document.querySelectorAll('#calendar td').forEach(td => {
          if (td.innerText.startsWith(String(Number(ds.slice(-2))))) td.classList.add('bg-blue-200');
        });
      });
      selDatesEl.textContent = selected.join(', ') || '없음';
      selCountEl.textContent = selected.length;
      applyBtn.disabled = selected.length === 0;
    }

    // 내 신청 내역 렌더
    function renderMyList() {
      myList.innerHTML = '';
      const data = getData();
      Object.keys(data).filter(date => data[date].includes(currentUser)).sort().forEach(date => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center';
        li.innerHTML = `<span>${date}</span><button class="text-red-500">X</button>`;
        li.querySelector('button').onclick = () => {
          if (!confirm('취소할까요?')) return;
          data[date] = data[date].filter(n => n !== currentUser);
          if (data[date].length === 0) delete data[date];
          saveData(data);
          renderCalendar(); renderMyList();
        };
        myList.appendChild(li);
      });
    }

    ['click','keydown','mousemove'].forEach(evt => document.addEventListener(evt, updateActivity));
    if (currentUser) { updateActivity(); showApp(); } else showAuth();
  });
  </script>
</body>
</html>
